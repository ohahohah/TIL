# 서버 부하 테스트 Server Load Test
[![License: CC BY-NC-ND 4.0](https://licensebuttons.net/l/by-nc-nd/4.0/80x15.png)](https://creativecommons.org/licenses/by-nc-nd/4.0/)

## Intro
- Performance Test? Load Test? Stress Test?
    [Software Testing Stuff: Performance Testing vs Load Testing vs Stress Testing - Examples](http://www.softwaretestingstuff.com/2011/09/performance-testing-vs-load-testing-vs.html)

- 실제로는 이렇게 진행
    [결제 시스템 성능, 부하, 스트레스 테스트 | 우아한형제들 기술블로그](https://techblog.woowahan.com/2572/)

    [[2019] 게임 서버 대규모 부하 테스트와 모니터링 이렇게 해보자](https://youtu.be/WhkZP4ZATmA)

    [실전 서버 부하테스트 노하우](https://www.slideshare.net/arload/bestcon-load-test)

## 목적

- 원활한 서비스 제공
- Availability 가용성 (서비스 정상 제공하는 상태) 높이기
- 온프레미스에서 부하테스트
    - 서버의 성능을 빠르게 동적으로 올리거나 조정하기 힘든 경우가 있음. 하드웨어 구성이 미리 되어있는 상태. 따라서 현재 구성되어 있는 시스템을 기준으로

    → 응답 성능 예측

    → 부하 많이 발생할 때 성능 개선

- 클라우드에서 부하테스트
    - 리소스 조정이 자유로움. (물론 예산 안에서)

    → 현재 설계된 아키텍쳐가 시스템 확장성 있는지 확인

    → 확장성 특성 파악 (어떤 상황에서 자동으로 시스템 확장되지?,...)

    - 더 나아가면, 예산 안에서 어떻게 하면 효율적으로 적은 금액으로 운영할 수 있는지
- 학습 관점에서
    - 현재 지식 수준에서는 원인을 파악하기 어려울 수가 있음. 여러 상황을 복합적으로 보고 판단해야함.
    - **어떻게 무엇을 테스트**했고 **예상되는 가설**은 무엇이었으며, 가설을 검증하기 위해 어떻게 재 테스트를 설계해서 진행했다 가 포인트. **점점 경험치 쌓아나가기!**
        - 처음부터 해결했다 를 목적으로 두지 말고 프로세스를 설계하는 경험에 초점두기

## Concept

- 장애는 여러 이유로 발생 - Network, H/W , 물리적 Server , SW,...
- 기본 이해를 위해 아래 concept 파악하기
    - Traffic
    - Latency
    - Throughput
    - Scale up / down, Scale out / in
    - 이중화 Redundancy
    - DAU, MAU
- cf. cloud 의 Availability 보장
- 모니터링 해야하는 항목
    - Network 전송량
    - OS : CPU, Memory, # of Process , Load Average,...
    - TCP connection status
    - disk : 전송 데이터량(Read 시 / Write 시), IOPS
    - connection 수
    - DB - Query 속도(너무 느리지 않은지), 프로세스 리스트
- 부하 테스트 프로세스
    1. 시나리오 설계
    2. 어떤 항목 / 시스템 테스트할지 설계 
        - 목표로 하는 성능지표 값이 있어야함
        - 사람들이 많이 쓰는 페이지(기능)
        - 리소스 많이 사용 예상되는 페이지 / 기능
            - 예. 이미지 동영상 업로드 다운로드
            - 동영상 보여주는 페이지 등 응답 콘텐츠 크기가 큰 페이지
            - 이미지 동영상 변환, 파일 압축 등
        - DB 사용하는 페이지
        - 외부 API 통신하는 페이지 - 외부 요청하는 속도도 고려해야함
    3. 부하 테스트
    4. 보고서 작성
        1. 병목지점 파악 
            1. 파악하기 위해 가설 세우고 추가 테스트 진행
        2. 현재 지식 수준에서는 원인을 파악하기 어려울 수가 있음. 여러 상황을 복합적으로 보고 판단해야함. 
            1. 어떻게 테스트했고 예상되는 가설은 무엇이었으며, 가설을 검증하기 위해 재 테스트를 진행했다 가 포인트. 점점 경험치 쌓아나가기
    5. 개선
    6. 재 테스트

## 설계시 기본 고려사항

- 사용자가 사용할 시나리오를 고려해서
    - 예. 5초에 한 번씩 사용자가 접속한다? 페이지 로딩이 느리면 새로고침을 계속 계속 누를 수 있다!
- 프로덕트의 성격을 고려해서
    - 예.
        - 쇼핑몰  블랙프라이데이 대비 Traffic 증가 예상, 배달 어플 점심, 저녁, 공휴일에 사용자 많아짐.
        - 콘서트 예매 사이트, 백신 예약 시스템 - 특정 시간에 폭발적으로 몰리는 Traffic. 접속자 순번 확인 중요
- 실제 프로덕트 환경과 유사하게 (적어도 staging server)
    - cloud 에서 Traffic 빠르게 처리할 수 있다고 해서 테스트가 필요없는 것은 아님
- 병목 지점 파악
    - 기반지식을 활용해 전략적으로 접근.
        - DB 는 디스크에서 읽고 쓰는 것. 속도가 가장 느린 부분 중에 하나. 웹 서버 세부 튜닝 잡는 거보다 DB 쿼리 튜닝을 하는게 더 나을 수 있다.
- 테스트하고 싶은 부분에 부하가 집중되고 있는지
- 추가로
    - 테스트는 여러 번, 개발일정에 포함해서 (출시 전 반짝, 잠깐 ⛔ )
    - 기본적인 Applicaton Error 처리

## Action

하나의 시나리오라도 직접 설계하고 개선해나가는 시도하기! 
**서버 부하테스트를 설계하고 시도하는 경험**
처음부터 복잡하게 여러 시나리오를 완벽히 테스트 ⛔

- 복잡한 전체 테스트를
- [ ]  현재 구성되어있는 아키텍처(구성)의 가용성, 확장성 평가 스스로 해보기
- [ ]  주요 사용자 시나리오 를 구성해보고, 해당 시나리오가 서버에 어떻게 영향을 미치는지 적어보기
    - [ ]  부하가 많이 발생되는 시나리오는?
- [ ]  서버가 비정상 응답하는 경우는 언제이지? (4XX,...)
- [ ]  로그가 성능을 저하시키고 있지 않나? (print, consol log 가 아닌 logging 사용)
- [ ]  부하 테스트 어떻게 하는지 개념 탑재
    - 부하 테스트 도구 무엇이 있나? (JMeter, Apache Bench,...)
- [ ]  [보고서] 어떤 테스트를 진행했는지 꼭 기록(보고서처럼) 남겨두기!
    - 이후 테스트 개선에도 도움이 됨.
- 상태 모니터링 어떻게 할 지 파악해보자
    - 기본적인 top, netstat 명령어 사용방법
    - AWS console 모니터링, cloudwatch
    - tool: New Relic, Goad,...

## More

- DB lock
- 서버 캐시 초기화
- 데이터 손실, 일관성 문제 (DB)
- Scale up / down 하면 문제가 해결될까? 어느 시점(어떤 지표가 관찰되었을 때) 에서 리소스를 늘려야할까?